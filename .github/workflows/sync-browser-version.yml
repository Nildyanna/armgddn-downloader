name: Sync Browser Version

"on":
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout downloader repository
        uses: actions/checkout@v4

      - name: Sync version to ArmgddnBrowser
        env:
          BROWSER_SYNC_PAT: ${{ secrets.BROWSER_SYNC_PAT }}
          BROWSER_REPO: Nildyanna/ArmgddnBrowser
          BROWSER_RESTART_URL: ${{ secrets.BROWSER_RESTART_URL }}
          BROWSER_RESTART_SECRET: ${{ secrets.BROWSER_RESTART_SECRET }}
        run: |
          set -euo pipefail

          if [ -z "${BROWSER_SYNC_PAT:-}" ]; then
            echo "Missing required secret BROWSER_SYNC_PAT (a PAT with write access to ${BROWSER_REPO})." >&2
            exit 1
          fi

          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ]; then
            echo "Failed to extract version from tag: $GITHUB_REF_NAME" >&2
            exit 1
          fi

          echo "Syncing Browser site_version to $VERSION"

          git clone "https://${BROWSER_SYNC_PAT}@github.com/${BROWSER_REPO}.git" browser

          cd browser

          if [ ! -f "default.php" ]; then
            echo "default.php not found in browser repo" >&2
            exit 1
          fi

          # Update browser UI version string
          sed -i "s/\$site_version = '.*';/\$site_version = '${VERSION}';/" default.php

          # Update credit line text (keeps dynamic version output)
          sed -i 's|Created by [^<]* v<?= $site_version ?>|Created by Old Man of the Hills (Beta) v<?= $site_version ?>|g' default.php

          # Verify the version was actually updated
          if ! grep -q "\$site_version = '${VERSION}';" default.php; then
            echo "Failed to update \$site_version in default.php (expected ${VERSION})" >&2
            echo "Found line:" >&2
            grep -n "\$site_version" default.php >&2 || true
            exit 1
          fi

          # Commit only if there are changes
          if git diff --quiet; then
            echo "No changes to commit (already at $VERSION)"
            exit 0
          fi

          git config user.name "armgddn-bot"
          git config user.email "armgddn-bot@users.noreply.github.com"

          git add default.php
          git commit -m "Sync site_version to ${VERSION}"

          echo "Attempting to push version sync directly to main..."
          if git push origin HEAD:main; then
            echo "Pushed to main successfully."

            if [ -n "${BROWSER_RESTART_URL:-}" ] && [ -n "${BROWSER_RESTART_SECRET:-}" ]; then
              echo "Triggering Browser restart..."
              set +e
              RESP_FILE="$(mktemp)"
              HTTP_CODE=$(curl -sS -o "$RESP_FILE" -w "%{http_code}" -X POST "${BROWSER_RESTART_URL%/}/api/admin/update-server" \
                -H "x-internal-secret: ${BROWSER_RESTART_SECRET}" \
                -H "content-type: application/json" \
                -d '{}')
              CURL_EXIT=$?
              set -e

              if [ "$CURL_EXIT" -ne 0 ]; then
                echo "Restart trigger failed to call endpoint (curl exit $CURL_EXIT)" >&2
              elif [ "$HTTP_CODE" != "200" ]; then
                echo "Restart trigger returned HTTP $HTTP_CODE" >&2
                head -c 300 "$RESP_FILE" >&2 || true
                echo >&2
              else
                echo "Restart triggered."
              fi
              rm -f "$RESP_FILE" || true
            else
              echo "Skipping restart trigger (missing BROWSER_RESTART_URL/BROWSER_RESTART_SECRET)."
            fi

            exit 0
          fi

          echo "Direct push to main failed; falling back to branch + PR."
          BRANCH="bot/sync-site-version-${VERSION}"
          git checkout -b "${BRANCH}" || git checkout "${BRANCH}"
          git push origin "HEAD:${BRANCH}" --force

          echo "Creating (or updating) PR for ${BRANCH} -> main"
          API_URL="https://api.github.com/repos/${BROWSER_REPO}/pulls"
          PR_TITLE="Sync site_version to ${VERSION}"
          PR_BODY="Automated sync from armgddn-downloader tag v${VERSION}."

          # If a PR already exists for this branch, do not fail.
          curl -sS -X POST \
            -H "Authorization: token ${BROWSER_SYNC_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "${API_URL}" \
            -d "{\"title\":\"${PR_TITLE}\",\"head\":\"${BRANCH}\",\"base\":\"main\",\"body\":\"${PR_BODY}\"}" \
            >/dev/null \
            || true
