name: Build ARMGDDN Downloader

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux
          - os: windows-latest
            platform: win32
          - os: macos-latest
            platform: mac

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Download bundled help video (GitHub Release asset)
        shell: bash
        run: |
          mkdir -p assets
          curl -L --fail -o assets/newmultipartzip.mp4 https://github.com/Nildyanna/armgddn-downloader/releases/download/assets-v1/newmultipartzip.mp4

      - name: Download rclone (Linux)
        if: matrix.platform == 'linux'
        run: |
          mkdir -p rclone/linux
          wget -q https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -q rclone-current-linux-amd64.zip
          mv rclone-*-linux-amd64/rclone rclone/linux/rclone
          chmod +x rclone/linux/rclone
          rm -rf rclone-*-linux-amd64*

      - name: Download rclone (Windows)
        if: matrix.platform == 'win32'
        shell: bash
        run: |
          mkdir -p rclone/win32
          curl -L -o rclone.zip https://downloads.rclone.org/rclone-current-windows-amd64.zip
          unzip -q rclone.zip
          mv rclone-*-windows-amd64/rclone.exe rclone/win32/rclone.exe
          rm -rf rclone-*-windows-amd64 rclone.zip

      - name: Download rclone (macOS)
        if: matrix.platform == 'mac'
        run: |
          mkdir -p rclone/darwin
          curl -L -o rclone.zip https://downloads.rclone.org/rclone-current-osx-amd64.zip
          unzip -q rclone.zip
          mv rclone-*-osx-amd64/rclone rclone/darwin/rclone
          chmod +x rclone/darwin/rclone
          rm -rf rclone-*-osx-amd64 rclone.zip

      - name: Generate macOS icon.icns
        if: matrix.platform == 'mac'
        shell: bash
        run: |
          mkdir -p build/icon.iconset
          sips -z 16 16     assets/icon.png --out build/icon.iconset/icon_16x16.png
          sips -z 32 32     assets/icon.png --out build/icon.iconset/icon_16x16@2x.png
          sips -z 32 32     assets/icon.png --out build/icon.iconset/icon_32x32.png
          sips -z 64 64     assets/icon.png --out build/icon.iconset/icon_32x32@2x.png
          sips -z 128 128   assets/icon.png --out build/icon.iconset/icon_128x128.png
          sips -z 256 256   assets/icon.png --out build/icon.iconset/icon_128x128@2x.png
          sips -z 256 256   assets/icon.png --out build/icon.iconset/icon_256x256.png
          sips -z 512 512   assets/icon.png --out build/icon.iconset/icon_256x256@2x.png
          sips -z 512 512   assets/icon.png --out build/icon.iconset/icon_512x512.png
          sips -z 1024 1024 assets/icon.png --out build/icon.iconset/icon_512x512@2x.png
          iconutil -c icns build/icon.iconset -o build/icon.icns
          rm -rf build/icon.iconset

      - name: Build Electron app (Linux)
        if: matrix.platform == 'linux'
        run: npm run build:linux -- --publish never

      - name: Build Electron app (Windows)
        if: matrix.platform == 'win32'
        run: npm run build:win -- --publish never

      - name: Build Electron app (macOS)
        if: matrix.platform == 'mac'
        run: npm run build:mac -- --publish never

      - name: Upload artifacts (Linux)
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            dist/*.AppImage
            dist/*.deb

      - name: Upload artifacts (Windows)
        if: matrix.platform == 'win32'
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/*.exe

      - name: Upload artifacts (macOS)
        if: matrix.platform == 'mac'
        uses: actions/upload-artifact@v4
        with:
          name: mac-build
          path: |
            dist/*.pkg

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: ./artifacts

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./artifacts

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: mac-build
          path: ./artifacts

      - name: List artifacts
        run: find ./artifacts -type f -ls

      - name: Create release README.txt
        shell: bash
        run: |
          cat > ./artifacts/README.txt <<'EOF'
          ARMGDDN Downloader ${{ github.ref_name }}

          Installation

          Windows:
          - Download the .exe installer
          - Run the installer

          macOS:
          - Download the .pkg
          - Run the installer
          - If the app doesn't work after install, run Fix.command:
            1) Open Fix.command
            2) If macOS blocks it, go to System Settings -> Privacy & Security and allow Fix.command
            3) Run it and enter your password in Terminal when prompted
          - To avoid security prompts for end users, the app must be signed with an Apple Developer ID certificate and notarized.

          Linux (Debian/Ubuntu):
          - Download .deb file
          - Install: sudo dpkg -i armgddn-downloader_*.deb

          Linux (Universal):
          - Download .AppImage file
          - Make executable: chmod +x ARMGDDN*.AppImage
          - Run: ./ARMGDDN*.AppImage
          EOF

      - name: Stage Fix.command for release
        shell: bash
        run: |
          cp ./build/Fix.command ./artifacts/Fix.command

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "ARMGDDN Downloader ${{ github.ref_name }}"
          body: |
            ## ARMGDDN Downloader ${{ github.ref_name }}
            
            ### Installation
            
            **Windows:**
            - Download the `.exe` installer
            - Run the installer

            **macOS:**
            - Download the `.pkg`
            - Run the installer
            - If the app doesn't work after install, run `Fix.command`:
              1) Open `Fix.command`
              2) If macOS blocks it, go to `System Settings` -> `Privacy & Security` and allow `Fix.command`
              3) Run it and enter your password in Terminal when prompted
            - To avoid security prompts for end users, the app must be signed with an Apple Developer ID certificate and notarized.
            
            **Linux (Debian/Ubuntu):**
            - Download `.deb` file
            - Install: `sudo dpkg -i armgddn-downloader_*.deb`
            
            **Linux (Universal):**
            - Download `.AppImage` file
            - Make executable: `chmod +x ARMGDDN*.AppImage`
            - Run: `./ARMGDDN*.AppImage`
          files: |
            artifacts/README.txt
            artifacts/Fix.command
            artifacts/*.deb
            artifacts/*.AppImage
            artifacts/*.exe
            artifacts/*.pkg
          draft: false
          prerelease: false
